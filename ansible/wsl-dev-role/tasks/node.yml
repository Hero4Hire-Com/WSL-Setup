- name: Install nvm
  ansible.builtin.shell: >
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash
  args:
    creates: "{{ ansible_env.HOME }}/.nvm/nvm.sh"

- name: Install node and set version
  shell: 
    /bin/bash -c "source ~/.nvm/nvm.sh && nvm install {{ node_version }} && nvm alias default {{ node_version }}"
  args:
    creates: "{{ ansible_env.HOME }}/.nvm/versions/{{ node_version }}"

- name: set NODE_EXTRA_CA_CERTS environment variable
  when: certs.stat.exists == True
  ansible.builtin.blockinfile:  
    marker: "# {mark} ANSIBLE MANAGED BLOCK"
    path: /home/{{ ansible_user_id }}/.profile
    block: |
      export NODE_EXTRA_CA_CERTS=/usr/local/share/ca-certificates/wincerts.pem

# - name: Get uptime information
    # when: certs.stat.exists == True
#   shell: |
#     . {{ ansible_env.HOME }}/.nvm/nvm.sh 
#     npm config ls -l >> out.txt
#   args:
#     executable: /bin/bash
#   register: result  

# - debug: var=result

- name: configure node to use certificates
  when: certs.stat.exists == True
  become: no
  shell: |
      . {{ ansible_env.HOME }}/.nvm/nvm.sh
      npm config set cafile=/usr/local/share/ca-certificates/wincerts.pem -L user
  args:
    executable: /bin/bash
    